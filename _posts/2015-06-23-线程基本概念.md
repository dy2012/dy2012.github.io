---
layout: post

title: 线程的基本概念

tags: [linux]

---

####线程是什么
>1. 线程是计算机中的可执行单元。

>2. 线程是机器中连续的，顺序的属性集合，一个线程包含执行一系列机器指令所必须的机器状态，包括当前指令位置，地址和数据寄存器等;一个进程中的所有线程共享地址空间。


####最适合使用线程的应用环境
>1. cpu bound，在多处理器系统上运行，可以将这些计算分解到多个worker线程中实现，提高系统的并行度。
>2. I/O bound，为了提高性能，将I/O操作重叠。很多线程可以同时等待不同的I/O操作。
>3.  分布式服务器应用就是很好的实例，它们必须响应多个客户的请求，必须为通过慢速的网络连接主动提供I/O做好准备。大部分程序有一些本质的并发，即使那种在处理器命令的同时从输入设备中读取下一个命令的简单并发。


####多线程编程模型的优点
>1. 在多处理器系统中提高程序的并行性。
>2. 在等待慢速外设I/O操作结束的同时，程序可以执行其他计算，为程序的并发提供更有效，更自然的开发方式。
>3. 一种模块化编程模型，能清晰地表达程序中独立事件间的相互关系。
>4. 多线程程序通常比串行程序更快，响应性能更好，它们比实现同样功能的非线程异步程序更易于开发和维护。

####线程的代价
> 源于线程同步的开销，线程调度的开销。如果创建的计算密集型线程比可用的处理器多，则可能比单线程实现获得更好的代码结构，但是程序性能也会更糟（有可能带来大量延迟）,即性能的损失是由于多线程结构在你要完成的工作上增加了额外的同步和调度开销，而可用的资源不变。这里涉及到多线程编程中线程数与cpu的core的数量有密切关系。

####线程系统的三个要素
* 可以从这方面来评估和比较线程系统
>1. 执行环境：并发实体的状态，并发系统必须提供建立，删除执行环境和独立维护它们状态的方式，它必须能够不时地保存好一个执行环境，而去执行另外一个环境。
>2. 调度：决定在某个给定时刻执行哪个环境，并在不同环境中切换。
>3. 同步：为并发执行的环境提供协调访问共享资源的一种机制。


####线程同步

>1. 基本的Pthreads同步模型使用互斥量来保护共享数据，使用条件变量来通信，还能用信号量，管道和消息队列来实现线程同步。
>2. 互斥量允许线程在访问共享数据时锁定它，以避免其他线程的干扰。条件变量允许线程等待共享数据到达某个期望的状态（如队列非空或者资源可用）；互斥量阻止线程间发生不可预期的冲突，一旦避免了冲突，条件变量让线程等待直到可以安全地执行，一般互斥量和条件变量搭配在一起用。


 
####线程安全
>1. 指代码能够被多个线程调用而不会产生灾难性结果。它不要求代码在多个线程中高效地运行，只要求能够安全地运行。
>2. 可重入：表示有效的线程安全，通过采用比将函数或库转换成一系列区域更为复杂的方式使代码成为线程安全的。通过引入互斥量和线程私有数据可以实现线程安全，但通常需要改变接口来使函数可重入。可重入的函数应该避免以来任何静态数据，最好避免依赖线程间任何形式的同步。


*  一个进程中的所有线程共享地址空间，线程间没有保护界限，如果一个线程使用未处理化的指针写内存，则可能破坏其他线程的堆栈或堆空间。
大部分现行函数可以利用pthreads提供的工具：互斥量，条件变量和线程私有数据，实现线程安全。

>1. 在进入函数时加锁，在退出函数时解锁，这样的函数可以被多个线程调用，但一次只能有一个线程调用它。
>2. 更有效的方式是将线程安全函数分为多个小的临界区，这样就允许多个线程进入该函数，虽然不能同时斯进入一个临界区。
更好的方式是将代码改造为对临界数据的保护而不是对临界代码的保护，这样就可以令不会同时访问相同临界数据的线程完全并行地执行。
>3. 正确的方法是将互斥量和数据流向关联，保护数据而不是代码。


####并发和并行的定义和区别
>1. 并发：实际上可能串行发生的事情好像同时发生一样。并发描述了单处理器系统中线程或进程的行为特点。在POSIX中，并发的定义要求延迟调用线程的函数不应该导致其他线程的无限期延迟。
并发操作之间可能任意交错，导致程序相互独立地运行，但是并发并不代表操作同时进行；然而，并发让程序能利用异步能力的特点，在无关操作运行的过程中继续工作。
>2. 并行：指并发序列同时执行。指事情在相同的方向上独立进行没有交错。
>3. 并行要求程序能够同时执行多个操作，而并发只要求程序能够假装同时执行多个操作；真正的并行只能在多处理器系统中存在，但是并发可以在单处理器系统和多处理器系统中都存在。






